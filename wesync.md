# 背景

1. 微信对API调用的封锁比较严重，即使作为公众号管理者，API的调用需要以access_token为接口调用凭据，access_token在2小时内有效，过期需要重新获取，但1天内获取次数有限
2. 微信公众号的历史记录页面URL包含一个校验的KEY，有效期为2个小时，而且 key 不通用，每个公众号必须单独生成
3. [http://weixin.sogou.com/](http://weixin.sogou.com/) 可以访问历史记录，但是只能访问最近的10条

# 爬取方式汇总

## [http://weixin.sogou.com/](http://weixin.sogou.com/)抓取最新内容

搜狗为微信提供了一个历史内容的搜索能力，通过一个稳定的链接 http://weixin.sogou.com/weixin?type=1&s_from=input&query={账号名称}&ie=utf8&_sug_=n&_sug_type_= 可以得到某个订阅号最近10条消息的集合页，然后可以进行爬取。

**优点：**

页面结构稳定，爬虫相对也就比较稳定

**缺点：**

1. 只能爬取最近10条消息，对于历史内容敏感的业务方不适用
2. 搜狗的反爬虫策略比较强大，同一个IP短时间内多次访问会有验证码，要么通过对爬虫设置随机因子尽量规避，要么需要费比较大的成本进行验证码攻破。

## 微信客户端+本地代理

由于不想陷入和搜狗之间的爬虫攻防战，所以必须另辟蹊径。

### 整体结构
因为微信的历史内容页面只能通过微信客户端访问，所以配合本地代理是可以抓取出来的。

整体系统结构如下图所示：

![](http://ossgw.alicdn.com/biu/1500258895263-RIpzPP5UuWOa2wnn.png)

爬取过程分为：
授权 -> 客户端脚本录入 -> 执行关注和访问历史内容页面的操作 -> 上传内容URL -> 格式化+本地化 ->再编辑 -> 存储

### https解析

在这套系统中，核心难点在于https报文的解析，业内已有成熟的中间人攻击解决方案。

#### 中间人攻击简介
以下来自维基百科：
> 在密码学和计算机安全领域中，中间人攻击（英语：Man-in-the-middle attack，缩写：MITM）是指攻击者与通讯的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的连接与对方直接对话，但事实上整个会话都被攻击者完全控制。在中间人攻击中，攻击者可以拦截通讯双方的通话并插入新的内容。在许多情况下这是很简单的（例如，在一个未加密的Wi-Fi 无线接入点的接受范围内的中间人攻击者，可以将自己作为一个中间人插入这个网络）。

> 一个中间人攻击能成功的前提条件是攻击者能将自己伪装成每一个参与会话的终端，并且不被其他终端识破。中间人攻击是一个（缺乏）相互认证的攻击。大多数的加密协议都专门加入了一些特殊的认证方法以阻止中间人攻击。例如，SSL协议可以验证参与通讯的一方或双方使用的证书是否是由权威的受信任的数字证书认证机构颁发，并且能执行双向身份认证。


根据中间人攻击的原理绘制了一个流程图：

![](http://ossgw.alicdn.com/biu/1500616274794-Ta5CcKEwO1fCBfzN.png)

需要说明的是：

1. 握手之后的对话使用"对话密钥"加密（对称加密），服务器的公钥和私钥只用于加密和解密"对话密钥"（非对称加密），无其他作用。
2. 服务器公钥放在服务器的数字证书之中。

### 实现方案

其实对于https报文的抓取已经有一个成熟的开源库 [anyproxy](https://github.com/alibaba/anyproxy)，该方案使用nodejs实现，可以通过加载rule的方式，自定义报文的拦截。

1. 首先需要将anyproxy导出的证书安装到手机上，作为中间人攻击中的受客户端信任的证书，从而信任Proxy产生的密钥
2. 将手机代理到AnyProxy机器上
3. 编写适合的rule，加载到anyproxy中，然后对应的报文就会通过这个rule文件，此处可以做报文的拦截上报

### 自动化方案

客户端的操作具有一定的规律，可以通过Monky脚本作为定时任务，此处暂时还没有完成，后续再补。。。

### 需要优化的地方

1. 使用模拟器代替手机，这样能增加系统的稳定性，减少维护成本
2. 自动化任务需要完善，需要识别微信对私有证书的对话框提示，并执行点击操作
3. 为了防止微信将客户端封锁（也许有这种策略），需要加入随机因子，模拟人的操作过程


### 优缺点

**优点：**

1. 完全模拟微信的操作，被封锁的可能性比较小
2. 可以爬取所有的历史内容
3. 可以爬取文章的留言、点赞、阅读数等

**缺点：**

1. 系统可能不稳定，受本地PC机器网络等影响比较大，维护成本可能比较大
2. 客户端自动化脚本的编写难度较大，也许需要root配合xposed才能比较完美的自动化执行
3. 无法得知公众号的更新情况，只能轮询（可以设置为每天一次，降低成本）

# 参考资料

1. [如何优雅的抓取微信公众号历史文章](https://laravel-china.org/articles/4269/how-to-grab-the-elegant-wechat-public-history)

2. [中间人攻击原理](https://zh.wikipedia.org/wiki/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB)

